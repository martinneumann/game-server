<header></header>

<body>
    <canvas id="game" width="1024" height="768">

    </canvas>
    <script src="/socket.io/socket.io.js"></script>
    <script>

        class Pose {
            x;
            y;
            w;  // orientation in whatever unit game maker provides
            constructor(x, y, w) {
                this.x = x;
                this.w = w;
                this.y = y;
            }
        }

        class PlayerState {
            id;
            pose;
            constructor (id, pose){
                this.id = id;
                this.pose = pose;
            }
        }

        function draw(){
            ctx.fillStyle = "#222222"
            ctx.fillRect(0,0,canvas.width, canvas.height);
            const canvasCenter = [canvas.width / 2, canvas.height / 2]
            const camPos = [player.pose.x + mouseOffset[0]/2, player.pose.y + mouseOffset[1]/2]

            for (var playerId in gameState) {
                ctx.fillStyle = gameState[playerId]["color"];
                ctx.fillRect(canvasCenter[0] + gameState[playerId]["pose"]["x"] - camPos[0], 
                            canvasCenter[1] + gameState[playerId]["pose"]["y"] - camPos[1], 
                             40, 
                             40);
            }
        }

        var diffPose = new Pose(0, 0, 0);
        var socket = io();
        var player;
        var mouseOffset = (0,0);
        var gameState;

        var canvas = document.getElementById('game');
        var ctx = canvas.getContext("2d");

        window.addEventListener('mousemove', function (e){
            mouseOffset = [e.offsetX - canvas.width / 2, e.offsetY - canvas.height / 2];
        })

        window.addEventListener('keydown', function (e) {
            e.preventDefault();
            diffPose.x = 0;
            diffPose.y = 0;
            switch (event.key) {
                case 'w':
                case 'W':
                    diffPose.y = -10;
                    break;
                case 'a':
                case 'A':
                    diffPose.x = -10;
                    break;
                case 's':
                case 'S':
                    diffPose.y = 10;
                    break;
                case 'd':
                case 'D':
                    diffPose.x = 10;
                    break;
                default:
                    break;
            }
            if (event.key) {
                socket.emit('keypressed', diffPose);
                event.key = '';
            }
        });

        window.setInterval(draw, 33);

        // New user connects.
        socket.on('newuser', (userid) => {
            console.log(`New user ${userid} connected.`);
            player = new PlayerState(userid, new Pose(0,0,0));
        });

        // General key press or movement or whatever.
        socket.on('movement', function (msg) {
            gameState = JSON.parse(msg)
            player.pose.x = gameState[player.id]["pose"]["x"]
            player.pose.y = gameState[player.id]["pose"]["y"]
        });
    </script>
</body>